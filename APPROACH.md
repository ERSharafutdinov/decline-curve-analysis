# Подход к решению задачи и методология

Этот документ описывает методологию и ключевые инженерные решения, использованные при разработке инструмента для анализа кривых падения добычи.

## 1. Постановка задачи

Необходимо было разработать автоматизированный инструмент для массового анализа и аппроксимации временных рядов добычи (темпов) большого количества скважин. Основные требования:
- Автоматически очищать данные от шумов и выбросов для повышения качества аппроксимации.
- Сравнить несколько математических моделей и выбрать для каждой скважины наилучшую.
- Предоставить результаты в удобном для дальнейшего анализа виде (таблицы, графики).

## 2. Математические модели

В основе анализа лежит сравнение 7 моделей, часто используемых в задачах Decline Curve Analysis (DCA) и не только. Все модифицированы так, чтобы `y=1` при `x=0`.

*   **Экспоненциальная:** `y = exp(-a*x) + (1-exp(-a*x))*b`
    *(Модель с насыщением до уровня `b`, хорошо описывает быстрое падение с последующей стабилизацией.)*
*   **Логарифмическая:** `y = 1 - a*ln(1+b*x)`
    *(Модель с постепенным затуханием, характерным для некоторых геологических процессов.)*
*   **Степенная:** `y = (1 + a*x)^(-b)`
    *(Классическая модель Арпса с гиперболическим падением в предельном случае.)*
*   **Гиперболическая:** `y = 1 / (1 + a*x**b)`
    *(Гибкая модель, частным случаем которой при `b=1` является гармоническая.)*
*   **Рациональная:** `y = (1 + a*x) / (1 + b*x)`
    *(Позволяет моделировать различные формы кривых, включая имеющие горизонтальную асимптоту.)*
*   **Гармоническая Арпса:** `y = 1 / (1 + a*x)`
    *(Частный случай гиперболической модели Арпса.)*
*   **Гиперболическая Арпса:** `y = (1 + b*a*x)^(-1/b)`
    *(Каноническая форма модели Арпса, широко используемая в нефтегазовой инженерии.)*

## 3. Ключевые алгоритмические решения

### 3.1 Принудительное соблюдение начального условия `(0,1)`

В реальных данных первый замер дебита редко бывает ровно в момент времени 0. Чтобы гарантировать выполнение физического условия, алгоритм:
1.  Нормализует все значения темпов на первый замер, чтобы `y[0]` стало равно 1.
2.  Если первый день (`x[0]`) больше 0, в начало массива данных принудительно добавляется точка `(0, 1.0)`.
3.  При подгонке кривой используется механизм весов: начальным и конечным точкам назначается более высокий вес. Это заставляет модель проходить через начало координат и лучше описывать "хвост" кривой.

### 3.2 Итеративное исключение выбросов

Промысловые данные часто зашумлены. Простое исключение статистических выбросов на начальном этапе может удалить полезную информацию. Поэтому был реализован итеративный подход:

1.  На каждой итерации строится аппроксимирующая кривая по текущему "чистому" набору данных.
2.  Вычисляются остатки (абсолютная разница между реальными значениями и кривой).
3.  Точка с **максимальным** остатком временно помечается как выброс и удаляется из набора для следующей итерации.
4.  Процесс повторяется, пока не будет достигнут один из критериев остановки: высокий `R²`, превышение максимально допустимой доли выбросов (`30%`) или малое количество оставшихся точек.
5.  Возвращается состояние (набор данных и модель) с **наилучшим достигнутым `R²`** за все итерации. Это гарантирует, что удаление точек было направлено именно на улучшение качества модели, а не просто на "зачистку" данных.

### 3.3 Выбор наилучшей модели и масштабирование

*   **Брутфорс по моделям:** Для каждой скважины последовательно применяются все 7 методов. Лучшим считается тот, чья итоговая модель (после очистки от выбросов) имеет наибольший коэффициент детерминации `R²`.
*   **Параллелизм:** Поскольку скважины обрабатываются независимо, задача идеально подходит для параллельных вычислений. Использование `multiprocessing.Pool` позволяет задействовать все ядра процессора, что критически важно при работе с сотнями и тысячами скважин (время выполнения сокращается в разы).

## 4. Оценка качества и интерпретация

*   **Метрика:** Основная метрика качества — `R²` (коэффициент детерминации). Значение `R² > 0.8`, как правило, говорит об отличном качестве подобранной модели. Модели с `R² < 0.5` помечаются как низкокачественные и требуют дополнительного анализа.
*   **Анализ выбросов:** Информация о количестве и доле удаленных точек сохраняется. Аномально высокая доля выбросов (`>20%`) для скважины может сигнализировать о нестабильном режиме работы или ошибках в замерах.
*   **Распределение моделей:** Анализ частоты использования моделей по всему месторождению может дать ценную геологическую информацию о преобладающем типе фильтрационных потоков.

## 5. Заключение

Разработанный инструмент представляет собой законченное решение для автоматизированного анализа кривых падения добычи. Он сочетает в себе классические инженерные подходы (модели Арпса) с современными методами обработки данных (итеративная очистка от выбросов, параллельные вычисления), что делает его мощным и надежным инструментом для специалистов.